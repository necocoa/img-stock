<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1521px" preserveAspectRatio="none" style="width:1403px;height:1521px;background:#FFFFFE;" version="1.1" viewBox="0 0 1403 1521" width="1403px" zoomAndPan="magnify"><defs><filter height="300%" id="f1j5480l0eptcd" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="Menlo" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="270" x="562.5" y="26.708">メッセージ配信ジョブを作成する</text><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="1303.3125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="101" y="143.8125"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="1269.1797" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="260" y="177.9453"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="622" y="291.7422"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="622" y="395.1406"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="129.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="622" y="1125.6641"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="802" y="438.2734"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1034" y="553.8047"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="116.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1034" y="778.1328"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1034" y="968.1953"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1034" y="1227.1953"/><rect fill="#FFFFFE" filter="url(#f1j5480l0eptcd)" height="1077.25" style="stroke: #000000; stroke-width: 2.0;" width="1242" x="13" y="192.9453"/><rect fill="#FFFFFE" filter="url(#f1j5480l0eptcd)" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="313" x="23" y="320.7422"/><rect fill="#FFFFFE" filter="url(#f1j5480l0eptcd)" height="254.5938" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="184" y="655.2031"/><rect fill="#FFFFFE" filter="url(#f1j5480l0eptcd)" height="223.4609" style="stroke: #000000; stroke-width: 2.0;" width="986" x="194" y="679.3359"/><rect fill="#FFFFFE" filter="url(#f1j5480l0eptcd)" height="266" style="stroke: #000000; stroke-width: 2.0;" width="1061" x="184" y="997.1953"/><rect fill="#FFFFFE" filter="url(#f1j5480l0eptcd)" height="61.3984" style="stroke: #000000; stroke-width: 2.0;" width="1041" x="194" y="1021.3281"/><rect fill="#FFFFFE" height="173.4688" style="stroke: none; stroke-width: 1.0;" width="1061" x="184" y="1089.7266"/><rect fill="#FFFFFE" filter="url(#f1j5480l0eptcd)" height="134.7969" style="stroke: #000000; stroke-width: 2.0;" width="1359" x="23" y="1284.1953"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="106" x2="106" y1="89.5469" y2="1465.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="265" x2="265" y1="89.5469" y2="1465.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="627" x2="627" y1="89.5469" y2="1465.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="807" x2="807" y1="89.5469" y2="1465.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="907" x2="907" y1="89.5469" y2="1465.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1039" x2="1039" y1="89.5469" y2="1465.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1180" x2="1180" y1="89.5469" y2="1465.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1296" x2="1296" y1="89.5469" y2="1465.125"/><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="142" x="33" y="54.25"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="40" y="74.2451">ECS_ScheduleTask</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="142" x="33" y="1464.125"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="40" y="1484.1201">ECS_ScheduleTask</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="204" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="235" y="57.9482">«Batch»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="211" y="74.2451">MessageRecive</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="204" y="1464.125"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="235" y="1484.1201">«Batch»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="211" y="1500.417">MessageRecive</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="590" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="597" y="57.9482">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="597" y="74.2451">Message</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="590" y="1464.125"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="597" y="1484.1201">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="597" y="1500.417">Message</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="770" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="777" y="57.9482">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="789" y="74.2451">User</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="770" y="1464.125"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="777" y="1484.1201">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="789" y="1500.417">User</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="854" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="877" y="57.9482">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="861" y="74.2451">UserMessage</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="854" y="1464.125"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="877" y="1484.1201">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="861" y="1500.417">UserMessage</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="970" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="1009" y="57.9482">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="977" y="74.2451">UserMessageTask</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="970" y="1464.125"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="1009" y="1484.1201">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="977" y="1500.417">UserMessageTask</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="1135" y="54.25"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1142" y="74.2451">AWS_Batch</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="1135" y="1464.125"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1142" y="1484.1201">AWS_Batch</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1235" y="54.25"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1242" y="74.2451">CloudWatchLog</text><rect fill="#FEFECE" filter="url(#f1j5480l0eptcd)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1235" y="1464.125"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1242" y="1484.1201">CloudWatchLog</text><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="1303.3125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="101" y="143.8125"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="1269.1797" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="260" y="177.9453"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="622" y="291.7422"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="622" y="395.1406"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="129.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="622" y="1125.6641"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="802" y="438.2734"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1034" y="553.8047"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="116.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1034" y="778.1328"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1034" y="968.1953"/><rect fill="#FFFFFF" filter="url(#f1j5480l0eptcd)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1034" y="1227.1953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="106" x2="153" y1="130.8125" y2="130.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="153" x2="153" y1="130.8125" y2="143.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="112" x2="153" y1="143.8125" y2="143.8125"/><polygon fill="#A80036" points="122,139.8125,112,143.8125,122,147.8125,118,143.8125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="118" y="110.6138">ScheduledTaskで</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="118" y="125.7466">毎時0分に実行</text><path d="M247,113.6133 L247,138.6133 L684,138.6133 L684,123.6133 L674,113.6133 L247,113.6133 " fill="#FBFB77" filter="url(#f1j5480l0eptcd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M674,113.6133 L674,123.6133 L684,123.6133 L674,113.6133 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="416" x="253" y="130.6802">メッセージ配信の頻度に合わせてScheduledTaskの細かさを変更する</text><polygon fill="#A80036" points="248,173.9453,258,177.9453,248,181.9453,252,177.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="111" x2="254" y1="177.9453" y2="177.9453"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="118" y="172.8794">メッセージ配信を実行</text><path d="M13,192.9453 L90,192.9453 L90,199.9453 L80,209.9453 L13,209.9453 L13,192.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1077.25" style="stroke: #000000; stroke-width: 2.0;" width="1242" x="13" y="192.9453"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="28" y="206.0122">loop</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175" x="105" y="205.1558">[メッセージ取得が0件になるまで]</text><polygon fill="#A80036" points="610,287.7422,620,291.7422,610,295.7422,614,291.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="616" y1="291.7422" y2="291.7422"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="277" y="226.145">ステータス: 未配信 and 配信日: 現時刻より前</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="285" y="241.2778">or</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="277" y="256.4106">ステータス: 配信中 and 配信日: 現時刻+1.5hより前</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="277" y="271.5435">order: 配信日の古い順</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="277" y="286.6763">一致するメッセージの先頭1件を取得</text><path d="M632,240.3438 L632,265.3438 L979,265.3438 L979,250.3438 L969,240.3438 L632,240.3438 " fill="#FBFB77" filter="url(#f1j5480l0eptcd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M969,240.3438 L969,250.3438 L979,250.3438 L969,240.3438 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="638" y="257.4106">配信中の+1.5hはバッチ処理の時間に合わせて調整する</text><polygon fill="#A80036" points="281,301.7422,271,305.7422,281,309.7422,277,305.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="626" y1="305.7422" y2="305.7422"/><path d="M23,320.7422 L108,320.7422 L108,327.7422 L98,337.7422 L23,337.7422 L23,320.7422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="313" x="23" y="320.7422"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="40" x="38" y="333.8091">break</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="123" y="332.9526">[メッセージが0件]</text><polygon fill="#A80036" points="122,355.0078,112,359.0078,122,363.0078,118,359.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="116" x2="259" y1="359.0078" y2="359.0078"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="128" y="353.9419">break</text><polygon fill="#A80036" points="610,391.1406,620,395.1406,610,399.1406,614,395.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="616" y1="395.1406" y2="395.1406"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="277" y="390.0747">メッセージのステータスを配信中に更新する</text><polygon fill="#A80036" points="281,405.1406,271,409.1406,281,413.1406,277,409.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="626" y1="409.1406" y2="409.1406"/><polygon fill="#A80036" points="790,434.2734,800,438.2734,790,442.2734,794,438.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="796" y1="438.2734" y2="438.2734"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="277" y="433.2075">ラストユーザーのIDを取得する max_user_id</text><polygon fill="#A80036" points="281,448.2734,271,452.2734,281,456.2734,277,452.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="806" y1="452.2734" y2="452.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="481.4063" y2="481.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="481.4063" y2="494.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="494.4063" y2="494.4063"/><polygon fill="#A80036" points="281,490.4063,271,494.4063,281,498.4063,277,494.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="277" y="476.3403">件数のステップ(100_000)を定数で用意 STEP_NUM</text><path d="M602,466.7734 L602,491.7734 L792,491.7734 L792,476.7734 L782,466.7734 L602,466.7734 " fill="#FBFB77" filter="url(#f1j5480l0eptcd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M782,466.7734 L782,476.7734 L792,476.7734 L782,466.7734 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="608" y="483.8403">メモリ次第で件数を変更する</text><polygon fill="#A80036" points="1022,549.8047,1032,553.8047,1022,557.8047,1026,553.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="1028" y1="553.8047" y2="553.8047"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="277" y="518.4731">message_id: message.id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="277" y="533.606">last_user_idが大きい順</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="277" y="548.7388">先頭から一つ取得</text><polygon fill="#A80036" points="281,563.8047,271,567.8047,281,571.8047,277,567.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="1038" y1="567.8047" y2="567.8047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="627.2031" y2="627.2031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="627.2031" y2="640.2031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="640.2031" y2="640.2031"/><polygon fill="#A80036" points="281,636.2031,271,640.2031,281,644.2031,277,640.2031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="277" y="591.8716">ステップの最初を設定</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="277" y="607.0044">もしすでにタスクが作られていたらそれ以降で試す</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="277" y="622.1372">first_user_id = (last_user_id || 0) + 1</text><path d="M184,655.2031 L253,655.2031 L253,662.2031 L243,672.2031 L184,672.2031 L184,655.2031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="254.5938" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="184" y="655.2031"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="199" y="668.27">opt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="248" x="268" y="667.4136">[first_user_idがmax_user_idより小さい]</text><path d="M194,679.3359 L271,679.3359 L271,686.3359 L261,696.3359 L194,696.3359 L194,679.3359 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="223.4609" style="stroke: #000000; stroke-width: 2.0;" width="986" x="194" y="679.3359"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="209" y="692.4028">loop</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="449" x="286" y="691.5464">[max_user_idまで 1.step(max_user_id, STEP_NUM) {|first_user_id|}]</text><polygon fill="#A80036" points="1022,774.1328,1032,778.1328,1022,782.1328,1026,778.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="1028" y1="778.1328" y2="778.1328"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="277" y="712.5356">message_id: message.id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="277" y="727.6685">first_user_id: first_user_id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="277" y="742.8013">last_user_id: first_user_id+STEP_NUM-1</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="277" y="757.9341">status: 未配信</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="277" y="773.0669">作成</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1044" x2="1086" y1="867.7969" y2="867.7969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1086" x2="1086" y1="867.7969" y2="880.7969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1045" x2="1086" y1="880.7969" y2="880.7969"/><polygon fill="#A80036" points="1055,876.7969,1045,880.7969,1055,884.7969,1051,880.7969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1051" y="802.1997">validate</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1051" y="817.3325">message_idと</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="1051" y="832.4653">first_user_idと</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="1051" y="847.5981">last_user_id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="1051" y="862.731">がunique</text><polygon fill="#A80036" points="281,890.7969,271,894.7969,281,898.7969,277,894.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="1038" y1="894.7969" y2="894.7969"/><polygon fill="#A80036" points="1022,964.1953,1032,968.1953,1022,972.1953,1026,968.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="1028" y1="968.1953" y2="968.1953"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="277" y="932.8638">message_id: message.id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="277" y="947.9966">status: 配信済以外</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="277" y="963.1294">をfirst_user_idが小さい順で取得</text><polygon fill="#A80036" points="281,978.1953,271,982.1953,281,986.1953,277,982.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="1038" y1="982.1953" y2="982.1953"/><path d="M184,997.1953 L253,997.1953 L253,1004.1953 L243,1014.1953 L184,1014.1953 L184,997.1953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="266" style="stroke: #000000; stroke-width: 2.0;" width="1061" x="184" y="997.1953"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="199" y="1010.2622">alt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="268" y="1009.4058">[タスクがある]</text><path d="M194,1021.3281 L271,1021.3281 L271,1028.3281 L261,1038.3281 L194,1038.3281 L194,1021.3281 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="61.3984" style="stroke: #000000; stroke-width: 2.0;" width="1041" x="194" y="1021.3281"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="209" y="1034.395">loop</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="286" y="1033.5386">[タスクの個数]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1178" x2="1168" y1="1074.7266" y2="1070.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1178" x2="1168" y1="1074.7266" y2="1078.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="1179" y1="1074.7266" y2="1074.7266"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="277" y="1054.5278">メッセージ配信(タスクID)を</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="277" y="1069.6606">AWS Batchジョブキューに追加</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="184" x2="1245" y1="1090.7266" y2="1090.7266"/><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="189" y="1100.937">[タスクがない]</text><polygon fill="#A80036" points="610,1121.6641,620,1125.6641,610,1129.6641,614,1125.6641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="616" y1="1125.6641" y2="1125.6641"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="277" y="1120.5981">メッセージを配信済にする</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="632" x2="674" y1="1169.9297" y2="1169.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="674" x2="674" y1="1169.9297" y2="1182.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="674" y1="1182.9297" y2="1182.9297"/><polygon fill="#A80036" points="643,1178.9297,633,1182.9297,643,1186.9297,639,1182.9297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="639" y="1149.731">メッセージのステータスを</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="639" y="1164.8638">配信済に更新</text><polygon fill="#A80036" points="1022,1223.1953,1032,1227.1953,1022,1231.1953,1026,1227.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="632" x2="1028" y1="1227.1953" y2="1227.1953"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="639" y="1206.9966">このメッセージのタスクを</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="639" y="1222.1294">すべて削除</text><polygon fill="#A80036" points="643,1237.1953,633,1241.1953,643,1245.1953,639,1241.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="637" x2="1038" y1="1241.1953" y2="1241.1953"/><polygon fill="#A80036" points="281,1251.1953,271,1255.1953,281,1259.1953,277,1255.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="626" y1="1255.1953" y2="1255.1953"/><path d="M23,1284.1953 L92,1284.1953 L92,1291.1953 L82,1301.1953 L23,1301.1953 L23,1284.1953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="134.7969" style="stroke: #000000; stroke-width: 2.0;" width="1359" x="23" y="1284.1953"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="38" y="1297.2622">opt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="107" y="1296.4058">[エラーが発生した場合]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1294" x2="1284" y1="1322.4609" y2="1318.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1294" x2="1284" y1="1322.4609" y2="1326.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="1295" y1="1322.4609" y2="1322.4609"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="277" y="1317.395">CloudWatchLogにログを出す</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1390" x2="1380" y1="1366.7266" y2="1362.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1390" x2="1380" y1="1366.7266" y2="1370.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1296" x2="1391" y1="1366.7266" y2="1366.7266"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="1303" y="1346.5278">Slack等</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="1303" y="1361.6606">通知を送る</text><polygon fill="#A80036" points="122,1406.9922,112,1410.9922,122,1414.9922,118,1410.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="116" x2="259" y1="1410.9922" y2="1410.9922"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="128" y="1390.7935">ジョブを</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="128" y="1405.9263">リトライする(2回)</text><polygon fill="#A80036" points="117,1443.125,107,1447.125,117,1451.125,113,1447.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="111" x2="264" y1="1447.125" y2="1447.125"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="123" y="1442.0591">終了</text><!--MD5=[35bf4180aa1765362c221edc944282d8]
@startuml
skinparam defaultFontName Menlo
skinparam backgroundColor #FFFFFE

title メッセージ配信ジョブを作成する

participant ECS_ScheduleTask as ScheduleTask
participant MessageRecive as MessageRecive <<Batch>>
participant Message as Message <<Model>>
participant User as User <<Model>>
participant UserMessage as UserMessage <<Model>>
participant UserMessageTask as UserMessageTask <<Model>>
participant AWS_Batch
participant CloudWatchLog

ScheduleTask -> ScheduleTask: ScheduledTaskで\n毎時0分に実行
note right: メッセージ配信の頻度に合わせてScheduledTaskの細かさを変更する
activate ScheduleTask
ScheduleTask -> MessageRecive: メッセージ配信を実行
activate MessageRecive

loop メッセージ取得が0件になるまで
  MessageRecive -> Message: ステータス: 未配信 and 配信日: 現時刻より前\n or \nステータス: 配信中 and 配信日: 現時刻+1.5hより前\norder: 配信日の古い順\n一致するメッセージの先頭1件を取得
  note right: 配信中の+1.5hはバッチ処理の時間に合わせて調整する
  activate Message
  Message - -> MessageRecive
  deactivate Message

  break メッセージが0件
    MessageRecive - -> ScheduleTask: break
  end

  MessageRecive -> Message: メッセージのステータスを配信中に更新する
  activate Message
  Message - -> MessageRecive
  deactivate Message

  MessageRecive -> User: ラストユーザーのIDを取得する max_user_id
  activate User
  User - -> MessageRecive
  deactivate User

  MessageRecive -> MessageRecive: 件数のステップ(100_000)を定数で用意 STEP_NUM
  note right: メモリ次第で件数を変更する

  MessageRecive -> UserMessageTask: message_id: message.id \nlast_user_idが大きい順\n先頭から一つ取得
  activate UserMessageTask
  MessageRecive <- - UserMessageTask
  deactivate UserMessageTask

  MessageRecive -> MessageRecive: ステップの最初を設定\nもしすでにタスクが作られていたらそれ以降で試す\nfirst_user_id = (last_user_id || 0) + 1

  opt first_user_idがmax_user_idより小さい
    loop max_user_idまで 1.step(max_user_id, STEP_NUM) {|first_user_id|}
      MessageRecive -> UserMessageTask: message_id: message.id\nfirst_user_id: first_user_id\nlast_user_id: first_user_id+STEP_NUM-1\nstatus: 未配信\n作成
      activate UserMessageTask
      UserMessageTask -> UserMessageTask: validate\nmessage_idと\nfirst_user_idと\nlast_user_id\nがunique
      UserMessageTask - -> MessageRecive
      deactivate UserMessageTask
    end
  end

  MessageRecive -> UserMessageTask: message_id: message.id \nstatus: 配信済以外\nをfirst_user_idが小さい順で取得
  activate UserMessageTask
  MessageRecive <- - UserMessageTask
  deactivate UserMessageTask

  alt タスクがある
    loop タスクの個数
      MessageRecive ->> AWS_Batch: メッセージ配信(タスクID)を\nAWS Batchジョブキューに追加
    end
  else タスクがない
    MessageRecive -> Message: メッセージを配信済にする
    activate Message

    Message -> Message: メッセージのステータスを\n配信済に更新

    Message -> UserMessageTask: このメッセージのタスクを\nすべて削除
    activate UserMessageTask
    Message <- - UserMessageTask
    deactivate UserMessageTask

    Message - -> MessageRecive
    deactivate Message
  end
end

opt エラーが発生した場合
  MessageRecive ->> CloudWatchLog: CloudWatchLogにログを出す
  CloudWatchLog ->>: Slack等\n通知を送る
  MessageRecive - -> ScheduleTask: ジョブを\nリトライする(2回)
end

MessageRecive - -> ScheduleTask: 終了
deactivate MessageRecive
deactivate ScheduleTask
@enduml

PlantUML version 1.2020.12(Sat Jun 06 19:54:15 JST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: ja
Country: JP
--></g></svg>