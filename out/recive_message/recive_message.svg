<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1537px" preserveAspectRatio="none" style="width:1065px;height:1537px;background:#FFFFFE;" version="1.1" viewBox="0 0 1065 1537" width="1065px" zoomAndPan="magnify"><defs><filter height="300%" id="f3edhe6rpn4c2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="Menlo" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="180" x="438.5" y="26.708">メッセージを配信する</text><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="1333.8516" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="63" y="128.6797"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="1284.5859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="216" y="177.9453"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="401" y="516.8828"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="129.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="401" y="1296.8672"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="581" y="590.2813"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="681" y="751.2109"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="681" y="920.0078"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="222.2109"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="349.7422"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="407.6797"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="1141.0703"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="1229.6016"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="1398.3984"/><rect fill="#FFFFFE" filter="url(#f3edhe6rpn4c2)" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="279" x="13" y="251.2109"/><rect fill="#FFFFFE" filter="url(#f3edhe6rpn4c2)" height="162.1406" style="stroke: #000000; stroke-width: 2.0;" width="884" x="13" y="311.4766"/><rect fill="#FFFFFE" height="57.9375" style="stroke: none; stroke-width: 1.0;" width="884" x="13" y="371.7422"/><rect fill="#FFFFFE" height="43.9375" style="stroke: none; stroke-width: 1.0;" width="884" x="13" y="429.6797"/><rect fill="#FFFFFE" filter="url(#f3edhe6rpn4c2)" height="329.7266" style="stroke: #000000; stroke-width: 2.0;" width="649" x="120" y="619.2813"/><rect fill="#FFFFFE" filter="url(#f3edhe6rpn4c2)" height="298.5938" style="stroke: #000000; stroke-width: 2.0;" width="629" x="130" y="643.4141"/><rect fill="#FFFFFE" filter="url(#f3edhe6rpn4c2)" height="178.9297" style="stroke: #000000; stroke-width: 2.0;" width="609" x="140" y="667.5469"/><rect fill="#FFFFFE" filter="url(#f3edhe6rpn4c2)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="235" x="150" y="780.2109"/><rect fill="#FFFFFE" filter="url(#f3edhe6rpn4c2)" height="134.7969" style="stroke: #000000; stroke-width: 2.0;" width="1031" x="13" y="963.0078"/><rect fill="#FFFFFE" filter="url(#f3edhe6rpn4c2)" height="175.7969" style="stroke: #000000; stroke-width: 2.0;" width="747" x="150" y="1258.6016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="68" x2="68" y1="89.5469" y2="1480.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="221" x2="221" y1="89.5469" y2="1480.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="406" x2="406" y1="89.5469" y2="1480.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="586" x2="586" y1="89.5469" y2="1480.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="686" x2="686" y1="89.5469" y2="1480.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="818" x2="818" y1="89.5469" y2="1480.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="958" x2="958" y1="89.5469" y2="1480.5313"/><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="23" y="54.25"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="30" y="74.2451">AWS_Batch</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="23" y="1479.5313"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="30" y="1499.5264">AWS_Batch</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="160" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="191" y="57.9482">«Batch»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="167" y="74.2451">MessageRecive</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="160" y="1479.5313"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="191" y="1499.5264">«Batch»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="167" y="1515.8232">MessageRecive</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="369" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="376" y="57.9482">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="376" y="74.2451">Message</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="369" y="1479.5313"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="376" y="1499.5264">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="376" y="1515.8232">Message</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="549" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="556" y="57.9482">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="568" y="74.2451">User</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="549" y="1479.5313"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="556" y="1499.5264">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="568" y="1515.8232">User</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="633" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="656" y="57.9482">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="640" y="74.2451">UserMessage</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="633" y="1479.5313"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="656" y="1499.5264">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="640" y="1515.8232">UserMessage</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="749" y="37.9531"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="788" y="57.9482">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="756" y="74.2451">UserMessageTask</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="749" y="1479.5313"/><text fill="#000000" font-family="Menlo" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="788" y="1499.5264">«Model»</text><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="756" y="1515.8232">UserMessageTask</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="897" y="54.25"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="904" y="74.2451">CloudWatchLog</text><rect fill="#FEFECE" filter="url(#f3edhe6rpn4c2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="897" y="1479.5313"/><text fill="#000000" font-family="Menlo" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="904" y="1499.5264">CloudWatchLog</text><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="1333.8516" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="63" y="128.6797"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="1284.5859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="216" y="177.9453"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="401" y="516.8828"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="129.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="401" y="1296.8672"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="581" y="590.2813"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="681" y="751.2109"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="681" y="920.0078"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="222.2109"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="349.7422"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="407.6797"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="1141.0703"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="1229.6016"/><rect fill="#FFFFFF" filter="url(#f3edhe6rpn4c2)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="813" y="1398.3984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="68" x2="115" y1="115.6797" y2="115.6797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="115" y1="115.6797" y2="128.6797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="74" x2="115" y1="128.6797" y2="128.6797"/><polygon fill="#A80036" points="84,124.6797,74,128.6797,84,132.6797,80,128.6797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="80" y="110.6138">ジョブを受け取る</text><polygon fill="#A80036" points="204,173.9453,214,177.9453,204,181.9453,208,177.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="73" x2="210" y1="177.9453" y2="177.9453"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="80" y="157.7466">メッセージを</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="80" y="172.8794">配信する(task_id)</text><path d="M231,149.2461 L231,174.2461 L438,174.2461 L438,159.2461 L428,149.2461 L231,149.2461 " fill="#FBFB77" filter="url(#f3edhe6rpn4c2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M428,149.2461 L428,159.2461 L438,159.2461 L428,149.2461 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="237" y="166.313">task_idを引数として受け取る</text><polygon fill="#A80036" points="801,218.2109,811,222.2109,801,226.2109,805,222.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="807" y1="222.2109" y2="222.2109"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="233" y="202.0122">タスクを取得</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="233" y="217.145">:find_by(id: task_id)</text><polygon fill="#A80036" points="237,232.2109,227,236.2109,237,240.2109,233,236.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="817" y1="236.2109" y2="236.2109"/><path d="M13,251.2109 L82,251.2109 L82,258.2109 L72,268.2109 L13,268.2109 L13,251.2109 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="279" x="13" y="251.2109"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="28" y="264.2778">opt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="75" x="97" y="263.4214">[taskがない]</text><polygon fill="#A80036" points="84,285.4766,74,289.4766,84,293.4766,80,289.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="78" x2="215" y1="289.4766" y2="289.4766"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="90" y="284.4106">終了</text><path d="M13,311.4766 L82,311.4766 L82,318.4766 L72,328.4766 L13,328.4766 L13,311.4766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="162.1406" style="stroke: #000000; stroke-width: 2.0;" width="884" x="13" y="311.4766"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="28" y="324.5435">alt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="97" y="323.687">[ステータスが未配信]</text><polygon fill="#A80036" points="801,345.7422,811,349.7422,801,353.7422,805,349.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="807" y1="349.7422" y2="349.7422"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="233" y="344.6763">タスクステータスを配信中に更新</text><polygon fill="#A80036" points="237,359.7422,227,363.7422,237,367.7422,233,363.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="817" y1="363.7422" y2="363.7422"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="13" x2="897" y1="372.7422" y2="372.7422"/><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="18" y="382.9526">[ステータスが配信中]</text><polygon fill="#A80036" points="801,403.6797,811,407.6797,801,411.6797,805,407.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="807" y1="407.6797" y2="407.6797"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="233" y="402.6138">タスクステータスを再配信中に更新</text><polygon fill="#A80036" points="237,417.6797,227,421.6797,237,425.6797,233,421.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="817" y1="421.6797" y2="421.6797"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="13" x2="897" y1="430.6797" y2="430.6797"/><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="18" y="440.8901">[配信済]</text><polygon fill="#A80036" points="84,461.6172,74,465.6172,84,469.6172,80,465.6172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="78" x2="215" y1="465.6172" y2="465.6172"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="90" y="460.5513">終了</text><polygon fill="#A80036" points="389,512.8828,399,516.8828,389,520.8828,393,516.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="395" y1="516.8828" y2="516.8828"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="233" y="496.6841">タスク.message_idの</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="233" y="511.8169">メッセージを取得</text><polygon fill="#A80036" points="237,526.8828,227,530.8828,237,534.8828,233,530.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="405" y1="530.8828" y2="530.8828"/><polygon fill="#A80036" points="569,586.2813,579,590.2813,569,594.2813,573,590.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="575" y1="590.2813" y2="590.2813"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="233" y="554.9497">id: first_user_id...last_user_id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="233" y="570.0825">配信許可: true</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="233" y="585.2153">plunk(:id)でユーザーIDを取得</text><polygon fill="#A80036" points="237,600.2813,227,604.2813,237,608.2813,233,604.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="585" y1="604.2813" y2="604.2813"/><path d="M120,619.2813 L217,619.2813 L217,626.2813 L207,636.2813 L120,636.2813 L120,619.2813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="329.7266" style="stroke: #000000; stroke-width: 2.0;" width="649" x="120" y="619.2813"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="135" y="632.3481">並列処理</text><path d="M130,643.4141 L207,643.4141 L207,650.4141 L197,660.4141 L130,660.4141 L130,643.4141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="298.5938" style="stroke: #000000; stroke-width: 2.0;" width="629" x="130" y="643.4141"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="145" y="656.481">loop</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="222" y="655.6245">[ユーザーIDの個数]</text><path d="M140,667.5469 L209,667.5469 L209,674.5469 L199,684.5469 L140,684.5469 L140,667.5469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="178.9297" style="stroke: #000000; stroke-width: 2.0;" width="609" x="140" y="667.5469"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="155" y="680.6138">opt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="224" y="679.7573">[ステータスが再配達]</text><polygon fill="#A80036" points="669,747.2109,679,751.2109,669,755.2109,673,751.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="675" y1="751.2109" y2="751.2109"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="233" y="700.7466">user_id: user_id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="233" y="715.8794">received_at: メッセージの配信時間</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="233" y="731.0122">filter onでmessage_idを指定</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="233" y="746.145">配信済みメッセージを取得する</text><polygon fill="#A80036" points="237,761.2109,227,765.2109,237,769.2109,233,765.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="685" y1="765.2109" y2="765.2109"/><path d="M150,780.2109 L219,780.2109 L219,787.2109 L209,797.2109 L150,797.2109 L150,780.2109 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="235" x="150" y="780.2109"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="165" y="793.2778">opt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="234" y="792.4214">[配信済みメッセージがある]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="268" y1="818.4766" y2="818.4766"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="268" x2="268" y1="818.4766" y2="831.4766"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="227" x2="268" y1="831.4766" y2="831.4766"/><polygon fill="#A80036" points="237,827.4766,227,831.4766,237,835.4766,233,831.4766" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="233" y="813.4106">next()</text><polygon fill="#A80036" points="669,916.0078,679,920.0078,669,924.0078,673,920.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="675" y1="920.0078" y2="920.0078"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="233" y="869.5435">user_id: user_id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="233" y="884.6763">received_at: 現時刻を数値型</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="233" y="899.8091">message_id: message.id</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="233" y="914.9419">ユーザーメッセージを作成</text><polygon fill="#A80036" points="237,930.0078,227,934.0078,237,938.0078,233,934.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="685" y1="934.0078" y2="934.0078"/><path d="M13,963.0078 L82,963.0078 L82,970.0078 L72,980.0078 L13,980.0078 L13,963.0078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="134.7969" style="stroke: #000000; stroke-width: 2.0;" width="1031" x="13" y="963.0078"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="28" y="976.0747">opt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="97" y="975.2183">[エラーが発生した場合]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="956" x2="946" y1="1001.2734" y2="997.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="956" x2="946" y1="1001.2734" y2="1005.2734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="957" y1="1001.2734" y2="1001.2734"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="233" y="996.2075">CloudWatchLogにログを出す</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1052" x2="1042" y1="1045.5391" y2="1041.5391"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1052" x2="1042" y1="1045.5391" y2="1049.5391"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="958" x2="1053" y1="1045.5391" y2="1045.5391"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="965" y="1025.3403">Slack等</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="965" y="1040.4731">通知を送る</text><polygon fill="#A80036" points="84,1085.8047,74,1089.8047,84,1093.8047,80,1089.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="78" x2="215" y1="1089.8047" y2="1089.8047"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="90" y="1069.606">ジョブを</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="90" y="1084.7388">リトライする(2回)</text><polygon fill="#A80036" points="801,1137.0703,811,1141.0703,801,1145.0703,805,1141.0703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="807" y1="1141.0703" y2="1141.0703"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="233" y="1120.8716">タスクのステータスを</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="233" y="1136.0044">配信済に更新</text><polygon fill="#A80036" points="237,1151.0703,227,1155.0703,237,1159.0703,233,1155.0703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="817" y1="1155.0703" y2="1155.0703"/><polygon fill="#A80036" points="801,1225.6016,811,1229.6016,801,1233.6016,805,1229.6016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="807" y1="1229.6016" y2="1229.6016"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="233" y="1179.1372">配信済以外のタスクを取得</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="233" y="1194.27">:where(message_id: message.id)</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="241" y="1209.4028">.where.not(status: 配信済)</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="241" y="1224.5356">.first</text><polygon fill="#A80036" points="237,1239.6016,227,1243.6016,237,1247.6016,233,1243.6016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="817" y1="1243.6016" y2="1243.6016"/><path d="M150,1258.6016 L219,1258.6016 L219,1265.6016 L209,1275.6016 L150,1275.6016 L150,1258.6016 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="175.7969" style="stroke: #000000; stroke-width: 2.0;" width="747" x="150" y="1258.6016"/><text fill="#000000" font-family="Menlo" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="24" x="165" y="1271.6685">opt</text><text fill="#000000" font-family="Menlo" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="234" y="1270.812">[配信済以外のタスクが無い]</text><polygon fill="#A80036" points="389,1292.8672,399,1296.8672,389,1300.8672,393,1296.8672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="226" x2="395" y1="1296.8672" y2="1296.8672"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="233" y="1291.8013">メッセージを配信済にする</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="411" x2="453" y1="1341.1328" y2="1341.1328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="453" x2="453" y1="1341.1328" y2="1354.1328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="412" x2="453" y1="1354.1328" y2="1354.1328"/><polygon fill="#A80036" points="422,1350.1328,412,1354.1328,422,1358.1328,418,1354.1328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="418" y="1320.9341">メッセージのステータスを</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="418" y="1336.0669">配信済に更新</text><polygon fill="#A80036" points="801,1394.3984,811,1398.3984,801,1402.3984,805,1398.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="411" x2="807" y1="1398.3984" y2="1398.3984"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="418" y="1378.1997">このメッセージのタスクを</text><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="418" y="1393.3325">すべて削除</text><polygon fill="#A80036" points="422,1408.3984,412,1412.3984,422,1416.3984,418,1412.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="416" x2="817" y1="1412.3984" y2="1412.3984"/><polygon fill="#A80036" points="237,1422.3984,227,1426.3984,237,1430.3984,233,1426.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="231" x2="405" y1="1426.3984" y2="1426.3984"/><polygon fill="#A80036" points="79,1458.5313,69,1462.5313,79,1466.5313,75,1462.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="73" x2="220" y1="1462.5313" y2="1462.5313"/><text fill="#000000" font-family="Menlo" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="85" y="1457.4653">終了</text><!--MD5=[217451107ca54032046cd5532de37deb]
@startuml
skinparam defaultFontName Menlo
skinparam backgroundColor #FFFFFE

title メッセージを配信する

participant AWS_Batch
participant MessageRecive as MessageRecive <<Batch>>
participant Message as Message <<Model>>
participant User as User <<Model>>
participant UserMessage as UserMessage <<Model>>
participant UserMessageTask as UserMessageTask <<Model>>
participant CloudWatchLog

AWS_Batch -> AWS_Batch: ジョブを受け取る
activate AWS_Batch
AWS_Batch -> MessageRecive: メッセージを\n配信する(task_id)
note right: task_idを引数として受け取る
activate MessageRecive

MessageRecive -> UserMessageTask: タスクを取得\n:find_by(id: task_id)
activate UserMessageTask
UserMessageTask - -> MessageRecive
deactivate UserMessageTask

opt taskがない
  MessageRecive - -> AWS_Batch: 終了
end

alt ステータスが未配信
  MessageRecive -> UserMessageTask: タスクステータスを配信中に更新
  activate UserMessageTask
  UserMessageTask - -> MessageRecive
  deactivate UserMessageTask
else ステータスが配信中
  MessageRecive -> UserMessageTask: タスクステータスを再配信中に更新
  activate UserMessageTask
  UserMessageTask - -> MessageRecive
  deactivate UserMessageTask
else 配信済
  MessageRecive - -> AWS_Batch: 終了
end

MessageRecive -> Message: タスク.message_idの\nメッセージを取得
activate Message
MessageRecive <- - Message
deactivate Message

MessageRecive -> User: id: first_user_id...last_user_id\n配信許可: true\nplunk(:id)でユーザーIDを取得
activate User
MessageRecive <- - User
deactivate User

group 並列処理
  loop ユーザーIDの個数
    opt ステータスが再配達
      MessageRecive -> UserMessage: user_id: user_id\nreceived_at: メッセージの配信時間\nfilter onでmessage_idを指定\n配信済みメッセージを取得する
      activate UserMessage
      MessageRecive <- - UserMessage
      deactivate UserMessage

      opt 配信済みメッセージがある
        MessageRecive -> MessageRecive: next()
      end
    end
    MessageRecive -> UserMessage: user_id: user_id\nreceived_at: 現時刻を数値型\nmessage_id: message.id\nユーザーメッセージを作成
    activate UserMessage
    MessageRecive <- - UserMessage
    deactivate UserMessage
  end
end

opt エラーが発生した場合
  MessageRecive ->> CloudWatchLog: CloudWatchLogにログを出す
  CloudWatchLog ->>: Slack等\n通知を送る
  MessageRecive - -> AWS_Batch: ジョブを\nリトライする(2回)
end

MessageRecive -> UserMessageTask: タスクのステータスを\n配信済に更新
activate UserMessageTask
MessageRecive <- - UserMessageTask
deactivate UserMessageTask

MessageRecive -> UserMessageTask: 配信済以外のタスクを取得\n:where(message_id: message.id)\n .where.not(status: 配信済)\n .first
activate UserMessageTask
MessageRecive <- - UserMessageTask
deactivate UserMessageTask

opt 配信済以外のタスクが無い
  MessageRecive -> Message: メッセージを配信済にする
  activate Message
  Message -> Message: メッセージのステータスを\n配信済に更新
  Message -> UserMessageTask: このメッセージのタスクを\nすべて削除
  activate UserMessageTask
  Message <- - UserMessageTask
  deactivate UserMessageTask

  Message - -> MessageRecive
  deactivate Message
end

MessageRecive - -> AWS_Batch: 終了
deactivate MessageRecive
deactivate AWS_Batch
@enduml

PlantUML version 1.2020.12(Sat Jun 06 19:54:15 JST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: ja
Country: JP
--></g></svg>